-- Script de diagnostic pour vérifier les politiques RLS sur la table orders
-- Exécutez ce script dans le SQL Editor de Supabase

-- 1. Lister toutes les politiques UPDATE sur la table orders
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual,
    with_check
FROM pg_policies 
WHERE tablename = 'orders' 
AND cmd = 'UPDATE';

-- 2. Vérifier les permissions de la table orders
SELECT 
    grantee,
    privilege_type
FROM information_schema.role_table_grants
WHERE table_name = 'orders'
AND table_schema = 'public';

-- 3. Tester si un utilisateur peut voir ses propres commandes
-- Remplacez 'USER_ID_HERE' par l'ID utilisateur réel
SELECT 
    id,
    status,
    user_id,
    auth.uid() as current_user_id,
    (auth.uid() = user_id) as is_owner,
    (status IN ('pending', 'confirmed')) as is_cancellable
FROM orders
WHERE user_id = '2a09bd3a-66dd-41d3-8ce4-a71450038456'
LIMIT 5;
